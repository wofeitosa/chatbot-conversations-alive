import { analyzeTextWithNLP } from '@/utils/nlpHelper';
import { remove as removeAccents } from 'diacritics';


interface OrderStatus {
  id: string;
  status: string;
  description: string;
  lastUpdate: string;
}

class ChatbotService {
  private intentions = {
    greeting: /^(oi+|ola+|ol√°+|hello+|hi+|bom\s?dia+|bomdia+|boa\s?tarde+|boatarde+|boa\s?noite+|boanoite+|eai+|e a√≠+|salve+|opa+)/i,
    orderQuery: /(pedido+s*|pedio+s*|consulta de pedido|consultar pedido|status|rastreio|rastreiar|onde\s?est[a√°]+|ondeesta+|meu\s?pedido+|meupedido+)/i,
    faq: /(horario+s*|hor√°rio+s*|funcionamento|contato+s*|telefone+s*|falar+|atendimento+)/i,
    scheduling: /(agendar+|agendamento+|marcar+|marcacao+|marca√ß√£o+|agenda+|reuniao+|reuni√£o+|consulta de horario|consultar horario|horario disponivel|disponivel+|dispon√≠vel+)/i,
    support: /(problema+s*|erro+s*|suporte+|tecnico+|t√©cnico+|nao\s?funciona+|n√£o\s?funciona+|bug+|falha+|travou+|travar+|naofunciona+|ajuda+|socorro+)/i,
    goodbye: /(tchau+|adeus+|obrigado+|obg+|vlw+|valeu+|ate\s?logo+|at√©\s?logo+|bye+|flw+|fui+|ate+|at√©+)/i,
  };


  private availableSchedule = {
    'ter√ßa': ['14h', '16h'],
    'quarta': ['10h', '15h', '17h'],
    'quinta': ['9h', '14h'],
    'sexta': ['11h', '16h'],
  };

  private invalidScheduleLogs: { userInput: string; normalized: string; timestamp: Date }[] = [];

  private normalizeText(text: string): string {
    return removeAccents(text.toLowerCase().trim());
  }

  async processMessage(message: string, channel: string): Promise<string> {
    console.log(`Processing message: "${message}" via ${channel}`);

    // Etapa 1: tentativa de detec√ß√£o com regex
    for (const [intent, pattern] of Object.entries(this.intentions)) {
      if (pattern.test(message)) {
        return await this.generateResponse(intent, message, channel);
      }
    }

    // Etapa 2: refor√ßo com NLP (compromise)
    const { keywords, normalized } = analyzeTextWithNLP(message);

    if (keywords.includes('pedido') || keywords.includes('compra')) {
      return await this.generateResponse('orderQuery', message, channel);
    }

    if (keywords.includes('agenda') || keywords.includes('hor√°rio') || keywords.includes('reuni√£o')) {
      return this.generateResponse('scheduling', message, channel);
    }

    if (keywords.includes('problema') || keywords.includes('erro')) {
      return this.generateResponse('support', message, channel);
    }

    // NOVO: Verifica√ß√£o extra para agendamento por padr√£o de dia + hor√°rio
    const dias = Object.keys(this.availableSchedule);
    const normMsg = this.normalizeText(message);

    for (const dia of dias) {
      const diaNorm = this.normalizeText(dia);
      const diaNormFeira = diaNorm.endsWith('a') ? diaNorm + '-feira' : diaNorm;
      if (normMsg.includes(diaNorm) || normMsg.includes(diaNormFeira)) {
        for (const h of this.availableSchedule[dia]) {
          const horarioNorm = this.normalizeText(h);
          // Express√£o regular para encontrar o par dia e hor√°rio juntos, em qualquer ordem
          const pattern = new RegExp(`\\b(${diaNorm}|${diaNormFeira})\\s*[-]?\\s*${horarioNorm}\\b|\\b${horarioNorm}\\s*[-]?\\s*(${diaNorm}|${diaNormFeira})\\b`);
          if (pattern.test(normMsg)) {
            // Chama diretamente a resposta de agendamento
            return this.getSchedulingResponse(message);
          }
        }
        // Se o dia foi encontrado mas nenhum hor√°rio v√°lido
        return this.getSchedulingResponse(message);
      }
    }

    // Etapa 3: fallback
    return this.generateFallbackResponse(channel);
  }


  private async generateResponse(intent: string, message: string, channel: string): Promise<string> {
    switch (intent) {
      case 'greeting':
        return this.getGreetingResponse(channel);
      
      case 'orderQuery':
        return await this.handleOrderQuery(message);
      
      case 'faq':
        return this.getFAQResponse(message);
      
      case 'scheduling':
        return this.getSchedulingResponse(message);
      
      case 'support':
        return this.getSupportResponse(channel);
      
      case 'goodbye':
        return this.getGoodbyeResponse();
      
      default:
        return this.generateFallbackResponse(channel);
    }
  }

  private getGreetingResponse(channel: string): string {
    const responses = [
      `üëã Ol√°! Sou o Chatbot, seu assistente via ${this.getChannelName(channel)}! Em que posso ajud√°-lo hoje?`,
      `üåü Oi! Que bom ter voc√™ aqui! Como posso tornar seu dia melhor?`,
      `üòä Ol√°! Estou aqui para ajudar com informa√ß√µes, consultas de pedidos e muito mais!`,
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }

  private async handleOrderQuery(message: string): Promise<string> {
    // Extract potential order ID from message
    const orderIdMatch = message.match(/\d{3,}/);
    
    if (orderIdMatch) {
      const orderId = orderIdMatch[0];
      try {
        // Simulate API call to check order status
        const orderStatus = await this.fetchOrderStatus(orderId);
        return `üì¶ Status do pedido #${orderId}:\n\nüîç ${orderStatus.status}\nüìã ${orderStatus.description}\nüïê √öltima atualiza√ß√£o: ${orderStatus.lastUpdate}\n\n‚ú® Algo mais em que posso ajudar?`;
      } catch (error) {
        return `‚ùå N√£o consegui encontrar informa√ß√µes sobre o pedido #${orderId}. Verifique se o n√∫mero est√° correto ou tente novamente em alguns minutos.`;
      }
    }
    
    return `üîç Para consultar seu pedido, me informe o n√∫mero (ex: "status do pedido 12345"). \n\nüí° Dica: O n√∫mero do pedido geralmente tem 4-6 d√≠gitos e est√° no seu email de confirma√ß√£o!`;
  }

  private async fetchOrderStatus(orderId: string): Promise<OrderStatus> {
    // Simulate API call with JSONPlaceholder-like response
    await new Promise(resolve => setTimeout(resolve, 800));
    
    const statuses = [
      { status: 'Em Prepara√ß√£o', description: 'Seu pedido est√° sendo preparado com carinho pela nossa equipe', lastUpdate: 'Hoje √†s 09:30' },
      { status: 'Em Transporte', description: 'Saiu para entrega! Chegar√° em breve no seu endere√ßo', lastUpdate: 'Hoje √†s 11:45' },
      { status: 'Entregue', description: 'Pedido entregue com sucesso! Esperamos que goste üòä', lastUpdate: 'Ontem √†s 16:20' },
      { status: 'Aguardando Pagamento', description: 'Aguardando confirma√ß√£o do pagamento para processar seu pedido', lastUpdate: 'Hoje √†s 08:15' },
    ];
    
    return {
      id: orderId,
      ...statuses[Math.floor(Math.random() * statuses.length)]
    };
  }

  private getFAQResponse(message: string): string {
    const normalized = this.normalizeText(message);

    if (normalized.includes('pedido') || normalized.includes('consultar pedido') || normalized.includes('consulta')) {
      return `üì¶ Para consultar pedidos, me envie o n√∫mero do pedido ou diga \"status do pedido 1234\".`;
    }

    if (normalized.includes('horario') || normalized.includes('funcionamento')) {
      return `üïê Nosso hor√°rio de funcionamento:\n\nüìû Atendimento: Segunda a Sexta, 8h √†s 18h\nü§ñ Chatbot: 24h por dia, 7 dias por semana!\nüì± WhatsApp: Segunda a S√°bado, 8h √†s 20h\n\n‚ú® Estou sempre aqui para ajudar!`;
    }

    if (normalized.includes('contato') || normalized.includes('telefone')) {
      return `üìû Formas de contato:\n\nü§ñ Chat inteligente (aqui mesmo!)\nüì± WhatsApp: (11) 9999-9999\nüìß Email: contato@empresa.com\nüåê Site: www.empresa.com\n\nüí¨ Prefere continuar comigo? Posso resolver a maioria das suas d√∫vidas!`;
    }

    if (normalized.includes('agendamento') || normalized.includes('agendar') || normalized.includes('marcar')) {
      return `üìÖ Para agendar, me diga o dia e hor√°rio desejado (ex: \"ter√ßa 14h"). Veja os hor√°rios dispon√≠veis acima!`;
    }

    if (normalized.includes('suporte') || normalized.includes('problema') || normalized.includes('erro')) {
      return `üõ†Ô∏è Suporte t√©cnico ativado!\n\nüîß Posso ajudar com problemas comuns:\n‚Ä¢ Login e senhas\n‚Ä¢ Navega√ß√£o no site\n‚Ä¢ Problemas de pedidos\n‚Ä¢ D√∫vidas sobre produtos\n\nüéØ Descreva seu problema que vou buscar a melhor solu√ß√£o!`;
    }

    // Resposta padr√£o
    return `üí° Posso ajudar com:\n\nüì¶ Consulta de pedidos\nüïê Hor√°rios de funcionamento\nüìû Informa√ß√µes de contato\nüìÖ Agendamentos\nüõ†Ô∏è Suporte t√©cnico\n\n‚ùì Me conte mais sobre o que precisa!`;
  }

 
  private getSchedulingResponse(userInput?: string): string {
    const agendarPalavras = [
      'agendar', 'agendamento', 'marcar', 'quero marcar', 'quero agendar',
      'quero um hor√°rio', 'quero horario', 'quero marcar horario'
    ];
  
    const disponibilidade = `üìÖ Agendamento dispon√≠vel!\n\nüóìÔ∏è Hor√°rios livres esta semana:
  ‚Ä¢ Ter√ßa: 14h, 16h
  ‚Ä¢ Quarta: 10h, 15h, 17h
  ‚Ä¢ Quinta: 9h, 14h
  ‚Ä¢ Sexta: 11h, 16h
  
  üìû Para confirmar, ligue (11) 9999-9999 ou continue aqui comigo!
  
  ‚è∞ Qual hor√°rio prefere?`;
  
    if (!userInput || agendarPalavras.some(p => this.normalizeText(userInput).includes(this.normalizeText(p)))) {
      return disponibilidade;
    }
  
    const normalized = this.normalizeText(userInput);
  
    for (const [dia, horarios] of Object.entries(this.availableSchedule)) {
      const diaNorm = this.normalizeText(dia); // exemplo: "quinta"
      const diaNormFeira = diaNorm.endsWith('a') ? diaNorm + '-feira' : diaNorm; // exemplo: "quinta-feira"
      for (const h of horarios) {
        const horarioNorm = this.normalizeText(h); // ex: "14h"
        // Express√£o regular para encontrar o par dia e hor√°rio juntos, em qualquer ordem, ignorando espa√ßos extras
        const pattern = new RegExp(`\\b(${diaNorm}|${diaNormFeira})\\s*[-]?\\s*${horarioNorm}\\b|\\b${horarioNorm}\\s*[-]?\\s*(${diaNorm}|${diaNormFeira})\\b`);
        if (pattern.test(normalized)) {
          return `‚úÖ Agendamento confirmado para ${dia.charAt(0).toUpperCase() + dia.slice(1)} √†s ${h}! Se precisar alterar, me avise.`;
        }
      }
      // se o dia foi encontrado mas nenhum hor√°rio v√°lido
      if (normalized.includes(diaNorm) || normalized.includes(diaNormFeira)) {
        return `‚ùå Hor√°rio n√£o dispon√≠vel para ${dia.charAt(0).toUpperCase() + dia.slice(1)}. Dispon√≠veis: ${horarios.join(', ')}.`;
      }
    }
    // se nenhum dia reconhecido
    return `‚ùå Hor√°rio n√£o dispon√≠vel. Veja os hor√°rios livres acima.\n\n${disponibilidade}`;
  }
veja    





  private getSupportResponse(channel: string): string {
    return `üõ†Ô∏è Suporte t√©cnico ativado!\n\nüîß Posso ajudar com problemas comuns:\n‚Ä¢ Login e senhas\n‚Ä¢ Navega√ß√£o no site\n‚Ä¢ Problemas de pedidos\n‚Ä¢ D√∫vidas sobre produtos\n\nüéØ Descreva seu problema que vou buscar a melhor solu√ß√£o!\n\nüìû Para casos complexos, posso conectar voc√™ com nossa equipe especializada.`;
  }

  private getGoodbyeResponse(): string {
    const responses = [
      `üëã Foi um prazer ajudar! Volte sempre que precisar! ‚ú®`,
      `üòä Tchau! Espero ter ajudado! Estarei aqui quando precisar! üåü`,
      `ü§ñ At√© logo! Lembre-se: estou sempre aqui, 24h por dia! üíô`,
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }

  private generateFallbackResponse(channel: string): string {
    const responses = [
      `ü§î Hmm, n√£o entendi muito bem. Pode reformular sua pergunta? Estou aqui para ajudar da melhor forma!`,
      `üí≠ Interessante! Ainda estou aprendendo sobre esse assunto. Que tal me contar mais detalhes?`,
      `üéØ Vou melhorar minha compreens√£o! Por enquanto, posso ajudar com consultas de pedidos, hor√°rios, agendamentos e informa√ß√µes gerais.`,
      `‚ú® Desculpe, n√£o captei essa. Sou especialista em pedidos, informa√ß√µes e suporte geral. Como posso ajudar especificamente?`,
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }

  private getChannelName(channel: string): string {
    const names = {
      web: 'Website',
      whatsapp: 'WhatsApp',
      sms: 'SMS',
      email: 'Email'
    };
    return names[channel as keyof typeof names] || 'Chat';
  }

  public getInvalidScheduleLogs() {
    return this.invalidScheduleLogs;
  }
}

export const chatbotService = new ChatbotService();
